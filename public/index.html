<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pet Diary Generator</title>
  <style>
    /* … your styles … */
  </style>
</head>
<body>
  <div class="container">
    <h1>Pet Diary Generator</h1>
    <button id="generateButton">Generate Diary</button>
    <div id="loader" class="loader" style="display:none;"></div>

    <div id="petDetails" class="output" style="display:none;">
      <h2>Pet Details</h2><pre id="petOutput"></pre>
    </div>
    <div id="destinationDetails" class="output" style="display:none;">
      <h2>Destination</h2><pre id="destinationOutput"></pre>
    </div>
    <div id="diaryDetails" class="output" style="display:none;">
      <h2>Diary Entry</h2><pre id="diaryOutput"></pre>
    </div>
    <div id="errorDetails" class="output" style="display:none; color:red;">
      <h2>Error</h2><pre id="errorOutput"></pre>
    </div>
  </div>

  <!-- 1) Compat SDKs for Hosting -->
  <script src="/__/firebase/9.0.0/firebase-app-compat.js"></script>
  <script src="/__/firebase/9.0.0/firebase-functions-compat.js"></script>
  <!-- 2) Auto-initialize + auto-emulator wiring -->
  <script src="/__/firebase/init.js?useEmulator=true"></script>

  <!-- 3) Your app logic, using the global `firebase` object -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const btn = document.getElementById("generateButton");
      const loader = document.getElementById("loader");
      const petOut = document.getElementById("petOutput");
      const destOut = document.getElementById("destinationOutput");
      const diaryOut = document.getElementById("diaryOutput");
      const errOut = document.getElementById("errorOutput");
      const petDiv = document.getElementById("petDetails");
      const destDiv = document.getElementById("destinationDetails");
      const diaryDiv = document.getElementById("diaryDetails");
      const errDiv = document.getElementById("errorDetails");

      // get the default app + functions instance
      const functions = firebase.app().functions("us-central1");

      btn.addEventListener("click", async () => {
        // reset UI
        btn.disabled = true;
        loader.style.display = "inline-block";
        [petDiv, destDiv, diaryDiv, errDiv].forEach(d => (d.style.display = "none"));
        [petOut, destOut, diaryOut, errOut].forEach(el => (el.textContent = ""));

        try {
          // 1️⃣ createPetFlow
          const createPet = firebase.functions().httpsCallable("createPet");
          const { data: petWrapper } = await createPet({});
          const pet = petWrapper.profile;
          console.log("Pet created:", petWrapper);
          if (!pet?.name || !pet?.introduction || !pet?.persona_dna) {
            throw new Error("Invalid pet data");
          }
          petOut.textContent = JSON.stringify(pet, null, 2);
          petDiv.style.display = "block";

          // 2️⃣ generateDestinationFlow
          const genDest = firebase.functions().httpsCallable("generateDestination");
          const { data: dest } = await genDest({ pet });
          if (!dest?.name || !dest?.description) {
            throw new Error("Invalid destination data");
          }
          destOut.textContent = JSON.stringify(dest, null, 2);
          destDiv.style.display = "block";

          // 3️⃣ generateDiaryFlow
          const genDiary = firebase.functions().httpsCallable("generateDiary");
          const { data: diary } = await genDiary({ pet, destination: dest });
          if (!diary?.title || !diary?.entry) {
            throw new Error("Invalid diary data");
          }
          diaryOut.textContent = `Title: ${diary.title}\n\n${diary.entry}`;
          diaryDiv.style.display = "block";

        } catch (e) {
          console.error(e);
          errOut.textContent = e.message;
          errDiv.style.display = "block";
        } finally {
          btn.disabled = false;
          loader.style.display = "none";
        }
      });
    });
  </script>
</body>
</html>
