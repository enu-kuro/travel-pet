# Travel Pet - 旅するデジタルペット「たびぺっち」

あなたのメールに届く、ちいさな世界の旅。

「たびぺっち」は、あなたのもとに毎日1通、小さな旅日記を届けるデジタルペットです。
ペットは気まぐれに世界を巡り、観光地だけでなく、誰も知らない村や、その日に話題になった遠い国の出来事、静かな港町の朝など、思いもよらない景色や物語をメールで教えてくれます。

## ✨ 概要

ユーザーが特定のメールアドレスにメールを送ると、そのユーザーだけのユニークなペットが生成されます。以降、そのペットが世界中を旅して、毎日AIが生成した絵日記をメールで送信します。

このプロジェクトは、日常にささやかな驚きと癒やしを提供することを目的とした、AIアプリケーションです。

## 🚀 技術的ハイライト

本プロジェクトでは、AI中心のアプリケーションを迅速に開発・運用するため、以下の技術を採用しています。

### 1. Genkit: AIネイティブな開発フレームワーク
Google製のGenkitフレームワークを全面的に採用し、AIフローの定義、ローカルでのテスト、本番環境へのデプロイを効率化しています。

- **宣言的なフロー定義**: ペットの生成、目的地の決定、日記の作成といった一連のAI処理を、TypeScriptで記述された `flow` として管理しています。これにより、複雑な処理の見通しが良くなり、メンテナンス性が向上します。
- **ローカル開発UI**: `genkit start` を実行することで、ローカル環境でフローの動作確認やデバッグが可能です。入力データをGUIから与え、実行結果やトレース情報をリアルタイムで確認できます。
- **プロンプト管理**: `.prompt` ファイルとしてプロンプトを外部管理することで、コードとプロンプトを分離し、非エンジニアでもプロンプトの改善・更新が容易になります。

### 2. マルチモーダルなAI活用
Googleの強力なAIモデルを組み合わせ、リッチなユーザー体験を実現しています。

- **Gemini**: ペットのプロフィールや、旅先での出来事を綴った日記の文章を生成します。`dotprompt` 形式で記述されたプロンプトテンプレートと連携し、動的で創造的なテキストを生成します。
- **Imagen**: 日記の文章に合わせて、その日の思い出を表現した画像を生成します。これにより、ユーザーはペットの旅をより鮮明にイメージできます。

### 3. サーバーレス・アーキテクチャ
Firebaseを中心としたサーバーレス構成により、スケーラビリティとメンテナンス性に優れたシステムを構築しています。

- **Firebase Cloud Functions (v2)**: メールの受信をトリガーに、ペット生成や日記作成のフローを実行します。イベント駆動でコードが実行されるため、リソースを効率的に活用できます。
- **Firestore**: ペットのプロフィールや過去の日記データを格納するデータベースとして利用しています。
- **Cloud Storage for Firebase**: Imagenが生成した画像を保存し、メールに添付する際に利用します。
- **Firebase Extensions (Resize Images)**: Imagenで生成された画像は容量が大きいため、Cloud Storageに保存された後、Firebase Extensionの「Resize Images」を利用して自動的に適切なサイズにリサイズされます。これにより、メール送信時のデータ量を削減し、ユーザー体験を向上させています。
- **Google Cloud Scheduler**: 毎日定時に日記生成フローをトリガーし、全ユーザーに日記を送信します。

### 4. メール駆動のユニークなUX
ユーザーはメールを送るだけでサービスを利用開始できます。このシンプルな体験の裏側では、以下の技術が連携しています。

- **IMAP/Nodemailer**: 特定のメールエイリアス（`+travel-pet`）へのメールをIMAPで定期的に監視し、新規ユーザーを検知します。日記の送信にはNodemailerを利用しています。

## 🎮 LLMによるゲームロジック制御の実験

本プロジェクトでは、従来のプログラマブルなゲームロジックではなく、**LLMにゲームの主要な判断と進行を委ねる**という実験的なアプローチを採用しています。これは、予測可能性よりも創発性と驚きを重視したゲームデザインの探求です。

### プロンプトによるランダム性の制御

ゲームにおけるランダム性を、従来の乱数生成ではなく**プロンプトエンジニアリングとtemperature設定**で表現しています：

- **目的地選定**: `temperature: 2.0`で高い創発性を持たせ、予想外の旅先選択を促進
- **日記生成**: `temperature: 1.0`で適度な一貫性を保ちながら、個性的な表現を生成
- **時事性の組み込み**: Google Search APIと組み合わせ、「直近1週間以内の出来事」という制約でリアルタイムな世界情勢を反映

### LLM制御の課題と発見

プロンプトでゲームロジックを制御する試みから、以下の課題と可能性が見えてきました：

**課題:**
- **偏りの制御**: LLMは学習データの偏りにより、特定の地域や話題に偏る傾向がある
- **一貫性の担保**: 同一ペットでも日によって性格が変わってしまう可能性
- **制御可能性**: 従来の条件分岐と比べ、意図した動作の保証が困難

**発見と可能性:**
- **創発的な物語**: 人間では思いつかない組み合わせや視点が自然に生まれる
- **コンテキスト理解**: ペットの個性（persona_dna）と世界情勢を組み合わせた、複雑な判断が可能
- **言語的な豊かさ**: 感情表現や文体の多様性が、手動実装では困難なレベルで実現

### 将来的な完全LLM制御の展望

現在の実装を発展させ、より包括的なLLM制御システムの実現可能性を探っています：

- **成長システム**: ペットの旅の経験が累積し、personality_dnaが動的に進化するシステム
- **イベント発生**: 世界情勢や季節、ユーザーとの関係性に基づいた特別なイベントの自動生成
- **多ペット間相互作用**: 複数のペットが出会い、影響し合うダイナミックなエコシステム
- **ユーザーフィードバック学習**: メールの開封率や返信内容から、ペットが学習・適応する仕組み

このアプローチは、「制御されたランダム性」ではなく「制御されない創発性」をゲームデザインの中心に据える、新しいエンターテインメントの形を模索するものです。

## 🏗 アーキテクチャの汎用性

本プロジェクトで構築した**Cloud Scheduler + Cloud Functions + AI**の組み合わせは、旅ペットだけでなく、様々なAI活用型定期配信サービスの基盤として活用可能な汎用性を持っています。

### 構築したサーバーレス構成の特徴

- **完全サーバーレス**: インフラ管理不要で、利用量に応じた自動スケーリング
- **イベント駆動**: スケジューラートリガーとHTTPトリガーの組み合わせによる柔軟な処理実行
- **AI統合**: Genkitフレームワークによる、AIフローの宣言的な定義と管理
- **データ永続化**: Firestoreによる、スケーラブルなユーザーデータ管理
- **外部連携**: Gmail/IMAP、外部API（検索、画像生成）との統合パターン

### 応用可能なサービス例

この技術スタックを応用することで、以下のようなサービスを迅速に構築できます：

**🗞 パーソナライズされたニュース配信**
- ユーザーの興味・職業・ライフスタイルに基づいた、AI生成のニュースダイジェスト配信
- 複数の情報源から関連記事を収集し、個人の視点で再構成した「あなただけのニュース」

**📊 定期的なAIレポート生成システム**
- 企業の業績データや市場動向を定期監視し、AI分析レポートを自動生成・配信
- ビジネス意思決定支援のための、カスタマイズされた洞察の提供

**🎨 ユーザー別カスタムコンテンツ配信サービス**
- 学習進度や興味分野に応じた、個人向け教育コンテンツの自動生成・配信
- アート、写真、音楽などの創作物を、ユーザーの嗜好に基づいてAIがキュレーション

**💡 AIを活用した定期配信型サービスの基盤としての価値**

この構成は、従来の「画一的な情報配信」から「個人に最適化された情報体験」への転換を可能にします：

- **低コスト・高スケーラビリティ**: サーバーレス構成により、小規模から大規模まで対応
- **AI活用の敷居の低さ**: Genkitにより、複雑なAI処理も宣言的に記述可能
- **プロトタイプから本格運用まで**: 同一のアーキテクチャで、段階的な成長が可能
- **データドリブンな改善**: Firestoreに蓄積されるデータから、継続的なサービス改善

このように、旅ペットで実証した「AI × 定期配信 × パーソナライゼーション」のパターンは、現代の情報過多社会において、**ユーザーにとって真に価値のある情報体験**を提供する基盤技術として、幅広い領域で活用できる可能性を秘めています。

## 🎯 参考サービス・インスピレーション

本プロジェクトは、デジタル世界における「育成」「見守り」「発見」の体験をデザインするにあたり、以下の先行サービスから深いインスピレーションを得ています。それぞれのサービスが提供する独特な体験価値を分析し、現代のAI技術で再解釈することを試みました。

### 🐸 旅かえる：コントロールできない「見守る楽しさ」

**旅かえるが提供した体験価値:**
- **能動的コントロールの放棄**: プレイヤーは旅の準備はできるが、カエルの行き先や帰宅時期は決められない
- **受動的な喜び**: 突然送られてくる旅の写真に一喜一憂する、予期しない感情体験
- **非同期的な関係性**: リアルタイムの相互作用ではなく、時間的なズレがある愛着形成

**たびぺっちでの再解釈:**
- LLMによる予測不可能な旅先選定により、ユーザーは「見守る」立場に置かれる
- メールという非同期媒体により、日常に突然現れる「小さな驚き」を再現
- ペットの個性（persona_dna）は固定だが、旅の選択は完全にペット（AI）主導

**進化点:**
- 現実世界の時事情報との連動により、架空の世界ではなく「今この瞬間の地球」との接続
- 画像とテキストの組み合わせによる、より豊かな情報量の提供

### 🧸 ぬい旅：第三者視点で旅を楽しむ体験

**ぬい旅が提供した体験価値:**
- **代理体験の喜び**: 自分の代わりに、愛着のあるものが新しい場所を訪れる体験
- **写真という証拠**: 「確かにそこにいた」という具体的な記録による実在感
- **コミュニティとの共有**: 他の人のぬい旅体験を見ることで広がる想像の世界

**たびぺっちでの再解釈:**
- デジタルペットが「ユーザーの分身」として世界を探索する構造
- AI生成画像により、実際には存在しない場面でも具体的な「旅の記録」を提供
- 個人的な体験でありながら、同時に誰も行ったことのない場所への「旅」を実現

**進化点:**
- 物理的な制約を超えた「どこでも行ける」自由度
- リアルタイム性：毎日新しい場所への旅が可能
- パーソナライゼーション：ペットの個性によって同じ場所でも異なる体験が生まれる

### 🥚 たまごっち：成長システムと長期的関係性の構築

**たまごっちが提供した体験価値:**
- **継続的な世話**: 毎日の小さな行動の積み重ねによる愛着形成
- **成長の実感**: 時間とともに変化する見た目や行動による、関係性の発展
- **責任感と絆**: 「世話をしなければ」という軽い責任感が生む、深い愛着

**たびぺっちでの再解釈:**
- 毎日届く日記により、継続的な「見守り」関係の構築
- ペットの旅の経験や学習により、徐々に変化していく可能性のある個性
- ユーザーは直接的な世話は不要だが、「読む」という行為で関係性を維持

**将来的な発展の可能性:**
- **蓄積による成長**: 旅の経験が積み重なることで、ペットの興味や視点が変化
- **ユーザーとの相互作用**: メールの返信や反応に基づいた、ペットの行動変化
- **多面的な関係性**: 単なる世話ではなく、「一緒に世界を発見する仲間」としての関係

### 現代的な再解釈としての価値

これらの先行サービスから学んだ「能動性と受動性のバランス」「継続的関係性の構築」「予期しない喜びの提供」という体験デザインの原則を、現代のAI技術と組み合わせることで、**デジタル時代の新しい「同伴者」体験**を創造することを目指しています。

単なる情報提供ではなく、ユーザーにとって「愛着の対象」であり「発見の案内役」でもある存在として、デジタルペットが機能することで、日常に小さな冒険と癒しをもたらす体験を提供します。

## 📊 システム構成図

![システム構成図](./systemDiagram.svg)


## 🛠️ セットアップと実行方法

### 前提条件
Firebaseプロジェクトの設定はできているものとします。

### Gmailアプリパスワードの取得
このプロジェクトでは、IMAP/Nodemailerによるメールの送受信にGmailアカウントを使用します。
**アプリパスワード**を取得して`EMAIL_APP_PASSWORD`に設定する必要があります。

### 1. 環境構築
```bash
# 1. リポジトリをクローン
git clone https://github.com/enu-kuro/travel-pet.git
cd travel-pet/functions

# 2. 依存関係をインストール
npm install
```

### 2. 環境変数の設定
Firebase Secret Managerに必要な情報を設定します。

- `EMAIL_ADDRESS`: Gmailのベースアドレス (例: `user@gmail.com`)
- `EMAIL_APP_PASSWORD`: Gmailのアプリパスワード

`.secret.local` ファイルをプロジェクトルートに作成し、ローカル開発用に同じ値を設定することも可能です。

### 3. ローカルでの開発
Genkitの開発UIを起動し、各フローを個別にテストできます。

```bash
# functionsディレクトリで実行
npm run genkit:start
```
ブラウザで `http://localhost:4000` を開くと、GenkitのUIが表示されます。ここから各フローを選択し、JSON形式で入力を与えて実行結果を確認できます。

### 4. 動作確認（Firebaseエミュレータ）
Cloud FunctionsとFirestoreをローカルでエミュレートして、全体の動作を確認します。

```bash
# functionsディレクトリで実行
npm run serve
```

### 5. デプロイ
Firebaseにファンクションをデプロイします。

```bash
# functionsディレクトリで実行
npm run deploy
```

## 📜 主な処理フロー

1.  **ペットの誕生 ([`emailCheckTrigger`](functions/src/index.ts#L14-L28))**:
    - ユーザーが `your-email+travel-pet@gmail.com` にメールを送信。
    - Cloud Schedulerで`emailCheckTrigger`をトリガーすることで、IMAPでメールを定期的に検知。（10分間隔）
    - [`createPetFlow`](functions/src/createPetFlow.ts) が実行され、Geminiがペットのプロフィールを生成。
    - Firestoreにペットのデータが保存される。
    - `配信停止`もここで同時に検知し、ペットデータを削除。

2.  **日記の生成 ([`dailyDiaryTrigger`](functions/src/index.ts#L30-L44))**:
    - 毎日、Cloud Schedulerがこのフローをトリガー。（午前5時30分）
    - [`generateDiariesForAllPets`](functions/src/diaryService.ts#L15-L67) が実行され、各ペットに対して以下の処理を行う:
        - [`generateDestinationFlow`](functions/src/generateDestinationFlow.ts) でGeminiがランダムな旅先を生成。
        - [`generateDiaryFlow`](functions/src/generateDiaryFlow.ts) でGeminiが日記の文章を、[`generateDiaryImageFlow`](functions/src/generateDiaryImageFlow.ts)でImagenが画像を生成。
    - 生成された日記データはFirestoreに保存される。

3.  **日記のメール送信 ([`dailyDiaryEmailTrigger`](functions/src/index.ts#L46-L60))**:
    - 毎日、Cloud Schedulerがこのフローをトリガー。（午前6時00分）
    - [`sendDiaryEmailsForAllPets`](functions/src/diaryService.ts#L71-L112) が実行され、生成された日記をNodemailer経由でユーザーにメール送信する。

4.  **ペットのクリーンアップ ([`dailyPetCleanup`](functions/src/index.ts#L62-L75))**:
    - 毎日、Cloud Schedulerがこのフローをトリガー。（午前3時30分）
    - [`deleteExpiredPets`](functions/src/petService.ts#L46-L74) が実行され、寿命に達したペットデータを削除する。
